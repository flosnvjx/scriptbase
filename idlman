#!/usr/bin/env shorthandzsh

setopt pipefail errexit
set -x

declare -A already_existing_outfn_sz
if [[ "$1" = get && $# = 3 ]]; then
  if [[ -e "$3.ing" ]]; then
    already_existing_outfn_sz+=("$3" "$(stat -c %s -- "$3")")
  fi
  until stdbuf -o 32M curl -q --no-progress-meter -gfL"${${already_existing_outfn_sz[$3]:#0}:+C${already_existing_outfn_sz[$3]}}" -y 185 -Y 10240 --retry 0 --url "$2" <&- >>"$3.ing"; do
    case "$?" in
     (52)
     sleep $((RANDOM%30+60))
     ;|
     (*)
       eval "echo return:$? >&2; exit $?"
     ;|
    esac
  done
  mv -vT -- "$3"{".ing",}
  exit
fi

declare +x idlpaste=
vared -chp idlpaste: idlpaste

declare -a idlargv=("${(@M)${(@f)idlpaste}:# #idman( ##/[dpf] ##\"[^\"]##\")## #}")

env -v true "${(@)idlargv}"

((#idlargv))
declare -a idltriplet=() urls=() outfns=()
while ((#idlargv)); do
  idltriplet=("${(@z)idlargv[1]## #idman #}")
  local url= outfn=
  while ((#idltriplet)); do
    case "${idltriplet[1]}" in
    (/d) url=${${idltriplet[2]%\"}#\"} ;;
    (/p) ;;
    (/f) outfn=${${idltriplet[2]%\"}#\"} ;;
    (*) return 1 ;;
    esac
    shift 2 idltriplet
  done
  urls+=("$url")
  outfns+=("$outfn")
  shift idlargv
done

if [[ -n "$1" && -d "$1/" ]]; then
  declare +x outdir=$1
else
  declare +x outdir=.
fi
outdir="$(readlink -e -- $outdir/)"

#builtin zmodload -Fa zsh/stat b:zstat
while ((#urls)); do
  local pgrep="$outdir/${outfns[1]}"
  function {
    setopt localoptions histsubstpattern extendedglob
    local match=()
    pgrep=${pgrep:gs/(#b)([.+^[|$]|\{|[\(])(#B)/'\\${match[1]}'/}
  }
  if pgrep -fcn -- '(^curl\.idlman:| +)'$pgrep' .*' >/dev/null; then
    : running
  elif [[ -e "$outdir/${outfns[1]}" ]]; then
    : downloaded
  else
    $0 get "${urls[1]}" "$outdir/${outfns[1]}" & disown
  fi
  shift urls outfns
done

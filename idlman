#!/usr/bin/env shorthandzsh

setopt pipefail errexit
set -x

declare +x idlpaste=
vared -chp idlpaste: idlpaste

declare -a idlargv=("${(@M)${(@f)idlpaste}:# #idman( ##/[dpf] ##\"[^\"]##\")## #}")

env -v true "${(@)idlargv}"

((#idlargv))
declare -a idltriplet=() urls=() outfns=()
while ((#idlargv)); do
  idltriplet=("${(@z)idlargv[1]## #idman #}")
  local url= outfn=
  while ((#idltriplet)); do
    case "${idltriplet[1]}" in
    (/d) url=${${idltriplet[2]%\"}#\"} ;;
    (/p) ;;
    (/f) outfn=${${idltriplet[2]%\"}#\"} ;;
    (*) return 1 ;;
    esac
    shift 2 idltriplet
  done
  urls+=("$url")
  outfns+=("$outfn")
  shift idlargv
done

if [[ -n "$1" && -d "$1/" ]]; then
  declare +x outdir=$1
else
  declare +x outdir=.
fi

#builtin zmodload -Fa zsh/stat b:zstat
declare -A already_existing_outfn_sz
while ((#urls)); do
  local pgrep="curl.idlman:${outfns[1]}"
  function {
    setopt localoptions histsubstpattern extendedglob
    local match=()
    pgrep=${pgrep:gs/(#b)([.+^[|$]|\{|[\(])(#B)/'\\${match[1]}'/}
  }
  if pgrep -fxcn -- $pgrep' .*' >/dev/null; then
    : running
  elif [[ -e "$outdir/${outfns[1]}" ]]; then
    : downloaded
  else
    if [[ -e "$outdir/${outfns[1]}.ing" ]]; then
      already_existing_outfn_sz+=("${outfns[1]}" "$(stat -c %s -- "$outdir/${outfns[1]}.ing")")
    fi
    ( <&- >>"$outdir/${outfns[1]}.ing" stdbuf -o 32M env -a "curl.idlman:${outfns[1]}" curl -q --no-progress-meter -gfL"${${already_existing_outfn_sz[${outfns[1]}]:#0}:+C${already_existing_outfn_sz[${outfns[1]}]}}" -y 185 -Y 10240 --retry 0 --url "${urls[1]}" && mv -vT -- "$outdir/${outfns[1]}"{".ing",} )& disown
  fi
  shift urls outfns
done
